#!/usr/bin/env bash
#set -euo pipefail

# Function to display help
# Function to display help
function show_help() {
    cat << EOF

DOX CLI - Development Operations Toolkit

USAGE
  dox <action> [arguments]

CORE COMMANDS
  version, --version       Show DOX CLI version
  help, --help            Show this help message
  config, configure       Configure tools and dependencies
  <tool> <action>         Run tool-specific actions

CONFIGURE
  dox config                      List all available tools
  dox config list                 List all available tools
  dox config <tool> [tool...]     Configure one or more tools
  dox config -f <file>            Configure from YAML file

TOOL ACTIONS
  dox <tool> <action> [args]      Execute tool-specific actions
  
  Examples:
    dox maven build               Configure Maven, then build
    dox docker build push         Configure Docker, then build and push

CONFIGURATION FILE
  Simple YAML format:
  
  kustomize:                      # Use default version
  kubectl:
    version: v1.35.0              # Specific version
  go:
    version: 1.25.6

ENVIRONMENT VARIABLES
  DOX_DIR              Installation directory (default: ~/.dox)
  DOX_CUSTOM_DIR       Configuration directory (default: ~/.dox/customize)
  DOX_RESOURCES_DIR    Resources directory (default: ~/dox_resources)
  <TOOL>_VERSION       Override tool version (e.g., KUBECTL_VERSION=v1.34.0)

EXAMPLES
  dox config                      List available tools
  dox config kubectl helm         Configure multiple tools
  dox config -f tools.yaml        Configure from file
  dox maven build                 Configure Maven and build
  KUBECTL_VERSION=v1.34.0 dox config kubectl

MORE INFO
  https://github.com/dopxlab/dox-cli

EOF
}

# Main script execution
action=${1:-help}
shift 2>/dev/null || true  # Remove the first argument (action) from the list
action_values=("$@")  # Capture the remaining arguments (tool names)

# Print the action and arguments (skip for help/version)
if [[ "$action" != "help" && "$action" != "--help" && "$action" != "version" && "$action" != "--version" ]]; then
    echo -e "\n▶️ DOX CLI running... Action: $action; Arguments: ${action_values[@]:-none}"
fi

# Directory paths for DOX (combined in one line for better readability)
export DOX_DIR="${DOX_DIR:-$HOME/.dox}"
export DOX_CLI_VERSION=$(cat "$DOX_DIR/version.txt" 2>/dev/null || echo "v0.1.0")
export DOX_CUSTOM_DIR="${DOX_CUSTOM_DIR:-$DOX_DIR/customize}"
export DOX_RESOURCES_DIR="${DOX_RESOURCES_DIR:-$HOME/dox_resources}"

# Set DOX_ENV to absolute path in DOX_DIR
# This ensures all scripts use the same env file location
export DOX_ENV="${PWD}/dox_env"

source ${DOX_DIR}/lib/shared/print.sh
source ${DOX_DIR}/lib/shared/env_handler.sh

# Function to validate arguments based on min and max
function validate_args() {
    local min=$1
    local max=$2
    local num_args=$3

    if [ "$num_args" -lt "$min" ]; then
        error "Error: Minimum $min argument(s) required."
        return 1
    elif [ "$max" != "-1" ] && [ "$num_args" -gt "$max" ]; then
        error "Error: Maximum $max argument(s) allowed."
        return 1
    fi
    return 0
}

# Function to check if required tools are installed
function check_tools() {
    local tools=("tar" "unzip" "curl" "yq")  # List of required tools

    for tool in "${tools[@]}"; do
        if ! command -v "$tool" &>/dev/null; then
            echo "$tool is not installed, which is required for DOX to run" >&2
            echo "Required tools: (${tools[*]})"
            exit 1
        fi
    done
}

# Check all tools
check_tools

on_before_execution #Handling env variables

# Handle actions based on user input
case "$action" in
  version | --version)
    echo "DOX CLI version: $DOX_CLI_VERSION"
    ;;

  help | --help)
    show_help
    ;;

  configure | config)
    # For 'configure' action, handle new options
    ${DOX_DIR}/lib/configure.sh "${action_values[@]}"
    # ✅ Source in current shell
    if [[ -f "$DOX_ENV" ]]; then
      source "$DOX_ENV"
      info "✓ Environment loaded. Variables are now available in this shell. To use in new shells, run:"
      print "   source ./dox_env"
    fi
    ;;
  
  *)
    # For any other action, call the action.sh script
    validate_args 1 -1 ${#action_values[@]} || exit 1
    source ${DOX_DIR}/lib/action.sh "$action" "${action_values[@]}"
    # ✅ Source in current shell
    if [[ -f "$DOX_ENV" ]]; then
      source "$DOX_ENV"
    fi
    ;;
esac

on_after_execution #Handling env variables