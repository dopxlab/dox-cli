# Installation and Configuration
installation:
  download:
    # Define version download paths from GitHub releases
    # https://github.com/docker/buildx/releases
    0.17.1:
      x86_64: "https://github.com/docker/buildx/releases/download/v0.17.1/buildx-v0.17.1.linux-amd64"
      arm64: "https://github.com/docker/buildx/releases/download/v0.17.1/buildx-v0.17.1.linux-arm64"
    0.16.2:
      x86_64: "https://github.com/docker/buildx/releases/download/v0.16.2/buildx-v0.16.2.linux-amd64"
      arm64: "https://github.com/docker/buildx/releases/download/v0.16.2/buildx-v0.16.2.linux-arm64"
    0.15.1:
      x86_64: "https://github.com/docker/buildx/releases/download/v0.15.1/buildx-v0.15.1.linux-amd64"
      arm64: "https://github.com/docker/buildx/releases/download/v0.15.1/buildx-v0.15.1.linux-arm64"

configuration:
  default_version: "${BUILDX_VERSION:-0.17.1}"

  dependencies:
    - docker

  # Install buildx as a Docker CLI plugin
  post_installation_script: |
    # Create Docker CLI plugins directory
    mkdir -p ~/.docker/cli-plugins/
    
    # Copy buildx binary to CLI plugins directory
    cp "${install_dir}/buildx-v${BUILDX_VERSION}.linux-$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')" ~/.docker/cli-plugins/docker-buildx
    
    # Make it executable
    chmod +x ~/.docker/cli-plugins/docker-buildx
    
    # Also create symlink in PATH for direct access
    ln -sf ~/.docker/cli-plugins/docker-buildx /usr/local/bin/docker-buildx

  # Print the installed version of the package
  post_configuration_script: |
    # Print the installed version
    docker buildx version
    whereis docker-buildx
    echo "Buildx installed at: ~/.docker/cli-plugins/docker-buildx"
    
    # List available builders
    docker buildx ls || true

# Configure and actions for buildx
configure: |
  dox configure buildx
  
  # Export common variables
  dox export DOCKER_PLATFORMS="${DOCKER_PLATFORMS:-linux/amd64,linux/arm64}"
  dox export BUILDX_BUILDER_NAME="${BUILDX_BUILDER_NAME:-dox-multiarch}"

variables:
  DOCKER_PLATFORMS: "${DOCKER_PLATFORMS:-linux/amd64,linux/arm64}"
  BUILDX_BUILDER_NAME: "${BUILDX_BUILDER_NAME:-dox-multiarch}"

actions:
  setup: |
    echo "Setting up Docker Buildx for multi-architecture builds..."
    
    # Setup QEMU for multi-arch emulation
    echo "Installing QEMU emulators..."
    docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    
    # Create buildx builder if it doesn't exist
    echo "Creating buildx builder: ${BUILDX_BUILDER_NAME}"
    docker buildx create --name ${BUILDX_BUILDER_NAME} --driver docker-container --use 2>/dev/null || docker buildx use ${BUILDX_BUILDER_NAME}
    
    # Bootstrap the builder
    echo "Bootstrapping builder..."
    docker buildx inspect --bootstrap
    
    # Show available platforms
    echo "Available platforms:"
    docker buildx inspect | grep Platforms
    
    echo "âœ… Buildx setup completed successfully"

  list: |
    echo "Available buildx builders:"
    docker buildx ls

  inspect: |
    echo "Inspecting builder: ${BUILDX_BUILDER_NAME}"
    docker buildx inspect ${BUILDX_BUILDER_NAME}

  remove: |
    echo "Removing builder: ${BUILDX_BUILDER_NAME}"
    docker buildx rm ${BUILDX_BUILDER_NAME}

  version: |
    docker buildx version