name: DOX CLI - Actions Test

on:
  push:
#    branches: [main]
      
env:
  DEBUG_MODE: ${{ vars.DEBUG_MODE }}
  OCI_REG_USER: ${{ vars.OCI_REG_USER }}
  OCI_REG_PASSWORD: ${{ secrets.OCI_REG_PASSWORD }}
  HELM_OCI_URL: ${{ vars.HELM_OCI_URL }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # Step 0: Checkout repo to access files
      - name: Checkout Repo
        uses: actions/checkout@v3

      # Step 1: Setup DOX CLI from repo files
      - name: Setup DOX CLI
        run: |
          rm -rf "$HOME/.dox/*"
          cp -r bin lib customize "$HOME/.dox/"

          echo "preview-${{ github.job }}" > "$HOME/.dox/version.txt"
          echo "$DOX_USER_BIN" >> $GITHUB_PATH

      # Step 2: Verify the installation
      - name: Verify DOX CLI installation
        run: |
          dox --version

      # Step 3: DOX Action for dockerfile
      - name: dox docker cat_dockerfile (for jdk 21)
        run: |
          export JDK_VERSION=21
          dox configure maven

          echo "MAVEN: Testing combination of Configuration + Action"
          mvn -v
          whereis mvn
          echo "JAVA 21: Testing combination of Configuration + Action"
          java -version
          whereis java
          dox docker cat_dockerfile

      # Step 4: DOX Action for helm build and push
      - name: dox helm template
        run: |
          dox helm template package

      # Step 5: DOX Action for argocd deploy
      - name: dox argocd deploy
        run: |
          dox argocd deploy

      # Step 6: DOX Action validating the installation path
      - name: dox maven test
        run: |
          dox maven test

      # Step 7: DOX Action for dockerfile
      - name: dox same shell test
        run: |
          export JDK_VERSION=23
          . dox configure maven # Same Shell Test
          echo ""
          echo "----------------------------------------"
          echo "dox_env"
          [ -f dox_env ] && cat dox_env || echo "‚ùå dox_env not found"
          echo "----------------------------------------"
          echo ""

          echo "MAVEN: Testing combination of Configuration + Action"
          mvn -v
          whereis mvn
          echo "JAVA 23: Testing combination of Configuration + Action"
          java -version
          whereis java